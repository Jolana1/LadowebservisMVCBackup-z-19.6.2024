using LadowebservisMVC.Controllers.Models;
using LadowebservisMVC.Models;
using System.Net;
using System.Net.Mail;
using System.Text;
using System.Web;
using System.IO;
using System;
using System.Linq;
using System.Collections.Generic;

namespace LadowebservisMVC.Util
{
    
    public class Mailer
    {
        // Block known spammer patterns (case-insensitive) - reject any containing 'loori'
        private static readonly string[] BannedEmailFragments = new[] { "loori" };
        private static readonly string[] BannedEmails = new[] 
        { 
            "dolnovam@mail.ru",
            "test@spam.ru",
            "margarita.stolyarova.26.05.1995@mail.ru",
            "judyhilly92@gmail.com",
            "dulal_ctg@yaoo.com",
            "ramyl_gilmanov@mail.ru",
            "slayd@t-online.de",
            "jessInjuff7037@gmail.com",
            "sergey-luzan98@mail.ru"
        };

        // Unsubscribe endpoint base URL - change to match your domain
        private static readonly string UnsubscribeBaseUrl = "https://ladowebservis.sk/Home/Unsubscribe";

        // Helper to build unsubscribe URL
        private static string GetUnsubscribeUrl(string customerEmail)
        {
            if (string.IsNullOrWhiteSpace(customerEmail)) return string.Empty;
            var encoded = HttpUtility.UrlEncode(customerEmail);
            return $"{UnsubscribeBaseUrl}?email={encoded}&token=marketing";
        }

        // Accepts optional attachment (HttpPostedFileBase) from MVC form file input
        public void OdoslanieSpravy(ContactModel_Sk model, HttpPostedFileBase attachment = null)
        {
            // Block known spammer patterns (case-insensitive) - reject any containing 'loori'
            if (model != null)
            {
                var email = (model.Email ?? string.Empty).ToLowerInvariant();
                var name = (model.Name ?? string.Empty);
                
                // Check banned emails list
                if (BannedEmails.Any(b => email.Equals(b, StringComparison.OrdinalIgnoreCase)))
                {
                    // silently ignore/send no mail for blocked senders
                    return;
                }

                // Check banned fragments
                if (BannedEmailFragments.Any(b =>
                        (!string.IsNullOrEmpty(email) && email.IndexOf(b, StringComparison.OrdinalIgnoreCase) >= 0) ||
                        (!string.IsNullOrEmpty(name) && name.IndexOf(b, StringComparison.OrdinalIgnoreCase) >= 0)))
                {
                    // silently ignore/send no mail for blocked senders
                    return;
                }
            }

            using (var mail = new MailMessage())
            {
                mail.From = new MailAddress("info@ladowebservis.sk", "ladowebservis.sk");
                mail.Headers["X-Mailer"] = "https://ladowebservis.sk/zdravie";
                mail.Subject = "Ďakujeme! Nech sa páči E-book je v prílohe";
                mail.IsBodyHtml = false;
                mail.SubjectEncoding = Encoding.UTF8;
                mail.BodyEncoding = Encoding.UTF8;

                // determine filename to display in body
                string attachedFileName = string.Empty;
                if (attachment != null && attachment.ContentLength > 0)
                {
                    attachedFileName = attachment.FileName;
                }
                else if (model.File != null && model.File.ContentLength > 0)
                {
                    attachedFileName = model.File.FileName;
                }

                // Build body with correct placeholders (admin notification)
                mail.Body = string.Format(
                    "\r\n Ahoj,\r\n ďakujem, že si sa prihlásil medzi ľudí, ktorým záleží na zdraví a energii.\r\nTu je tvoj e-book zdarma:\r\n Vaše meno: {0} ,\r\n Váš email: {1} ,\r\n Potvrdenie hesla: {2}," +
                    "\r\n Priložený súbor:Päť_prirodzených_ciest_k_väčšej_energii od_Zinzina {4}" +
                    "\r\n Vaša správa: {5}," +
                    "\r\n Prajem ti, aby si v ňom našiel inšpiráciu pre zdravší a pokojnejší deň.\r\n Prečítaj si ho prosím a dozvieš sa viac ako dostať svoje telo späť do rovnováhy zdravia.\r\n\r\nS pozdravom,\nTím ladowebservis.sk" +
                    "\r\n\r\n---\r\n📧 SPRÁVA O EMAILOCH:\r\nAk si neželáte dostávať ďalšie ponuky a novinky, kliknite sem: {6}\r\n\r\nStále budete dostávať informácie o svojich objednávkach.",
                    model.Name,
                    model.Email,
                    model.Password,
                    model.File,
                    attachedFileName,
                    model.Text,
                    GetUnsubscribeUrl(model.Email));
                mail.BodyEncoding = Encoding.UTF8;
                if (!string.IsNullOrWhiteSpace(model.Email))
                {
                    try
                    {
                        var addr = new MailAddress(model.Email);
                        mail.To.Add(model.Email);
                    }
                    catch
                    {
                        // invalid email, do not attempt send to user
                        mail.To.Add("info@ladowebservis.sk");
                    }
                }
                else
                {
                    mail.To.Add("info@ladowebservis.sk");
                }

                mail.Bcc.Add("info@ladowebservis.sk");

                // Attach file from parameter if provided, otherwise from model.File if present
                if (attachment != null && attachment.ContentLength > 0)
                {
                    var mailAttachment = new Attachment(attachment.InputStream, attachment.FileName, attachment.ContentType);
                    mail.Attachments.Add(mailAttachment);
                }
                else if (model.File != null && model.File.ContentLength > 0)
                {
                    var mailAttachment = new Attachment(model.File.InputStream, model.File.FileName, model.File.ContentType);
                    mail.Attachments.Add(mailAttachment);
                }

                // Also attach a bundled PDF (App_Data/MailAttachment.pdf) if it exists
                try
                {
                    var context = HttpContext.Current;
                    if (context != null)
                    {
                        var pdfPath = context.Server.MapPath("~/App_Data/MailAttachment.pdf");
                        if (File.Exists(pdfPath))
                        {
                            var pdfAttachment = new Attachment(pdfPath);
                            mail.Attachments.Add(pdfAttachment);
                        }
                    }
                }
                catch
                {
                    // ignore failures attaching the bundled PDF
                }

                using (var client = new SmtpClient("email.active24.com"))
                {
                    client.EnableSsl = true;
                    client.Port = 587;
                    client.UseDefaultCredentials = false;
                    client.Credentials = new NetworkCredential("info@ladowebservis.sk", "a98HdiBMYNRH");


                    client.Send(mail);
               }
            }

            // Send follow-up email with registration invitation and benefits
            try
            {
                if (!string.IsNullOrWhiteSpace(model?.Email))
                {
                    SendContactFollowUpEmail(model.Email, model.Name);
                }
            }
            catch
            {
                // ignore follow-up email errors
            }
        }

        /// <summary>
        /// Send a follow-up email after contact form submission with registration invitation,
        /// promo code, cart reminder, and membership benefits
        /// </summary>
        private void SendContactFollowUpEmail(string customerEmail, string customerName = null)
        {
            if (string.IsNullOrWhiteSpace(customerEmail)) return;

            try
            {
                // Validate email
                try { var _ = new MailAddress(customerEmail); } catch { return; }

                var nameSafe = string.IsNullOrWhiteSpace(customerName) ? "" : HttpUtility.HtmlEncode(customerName).Trim();
                var promoCode = "NOVYROK26";

                using (var mail = new MailMessage())
                {
                    mail.From = new MailAddress("info@ladowebservis.sk", "ladowebservis.sk");
                    mail.To.Add(customerEmail);
                    mail.Bcc.Add("info@ladowebservis.sk");
                    mail.Subject = "✨ Kolagén pre krásu + 10% zľava s kódom " + promoCode;
                    mail.SubjectEncoding = Encoding.UTF8;
                    mail.BodyEncoding = Encoding.UTF8;
                    mail.IsBodyHtml = false;

                    var sb = new StringBuilder();
                    
                    // Personalized greeting
                    if (!string.IsNullOrWhiteSpace(nameSafe))
                    {
                        sb.AppendLine("Dobrý deň " + nameSafe + ",");
                    }
                    else
                    {
                        sb.AppendLine("Dobrý deň,");
                    }

                    sb.AppendLine();
                    sb.AppendLine("Ďakujeme, že ste nás kontaktovali! Máme pre Vás špeciálnu ponuku na kolagénový produkt pre vašu krásu.");
                    sb.AppendLine();
                    
                    // Collagen Boozt Special Offer
                    sb.AppendLine("═══════════════════════════════════════");
                    sb.AppendLine("  ✨ KOLAGÉN PRE KRÁSU - ŠPECIÁL");
                    sb.AppendLine("═══════════════════════════════════════");
                    sb.AppendLine();
                    sb.AppendLine("🌟 COLLAGEN BOOZT - Prírodný kolagén 85 €");
                    sb.AppendLine("   Teraz so ŠPECIÁLNOU ZĽAVOU -10%!");
                    sb.AppendLine("   Cena: len 76,50 € (z 85 €)");
                    sb.AppendLine();
                    sb.AppendLine("   Prémium kolagénový produkt od Zinzino -");
                    sb.AppendLine("   perfektný výber pre pekný vzhľad a zdravú");
                    sb.AppendLine("   pokožku. Vďaka prirodzeným zložkám si");
                    sb.AppendLine("   užijete viditeľné výsledky v priebehu");
                    sb.AppendLine("   niekoľkých týždňov.");
                    sb.AppendLine();
                    sb.AppendLine("   Vlastnosti:");
                    sb.AppendLine("   • Zlepšuje elasticitu pokožky");
                    sb.AppendLine("   • Zmierňuje vrásky a jemné linky");
                    sb.AppendLine("   • Podporuje zdravie vlasov a nechtov");
                    sb.AppendLine("   • 100% prírodný pôvod");
                    sb.AppendLine();
                    sb.AppendLine("   👉 Pozrieť a objednať: https://ladowebservis.sk/Home/Produkty?q=collagen");
                    sb.AppendLine();
                    sb.AppendLine("═══════════════════════════════════════");
                    sb.AppendLine();
                    
                    // Promo code highlight
                    sb.AppendLine("🎉 EXKLUZÍVNY PROMO KÓD: " + promoCode);
                    sb.AppendLine("💰 Získajte 10% ZĽAVU na nákup vybraných produktov pri platbe");
                    sb.AppendLine("🚀 Kombinujte s kolagénovou zľavou!");
                    sb.AppendLine("⏰ Platnosť: 1 mesiac");
                    sb.AppendLine();

                    // Product recommendations
                    sb.AppendLine("🌟 ĎALŠIE ODPORÚČANÉ PRODUKTY PRE VAŠU KRÁSU:");
                    sb.AppendLine();
                    sb.AppendLine("• Balance Oil - Omega 3 pre zdravé srdce a mozog");
                    sb.AppendLine("  (Krása začína zvnútra – vďaka dobrému zdraviu!)");
                    sb.AppendLine("  https://ladowebservis.sk/Home/Produkty?q=balance");
                    sb.AppendLine();
                    sb.AppendLine("• Zinobiotic - Prémiové probiotiká pre trávenie");
                    sb.AppendLine("  (Zdravá pokožka závisí na zdravom trávení)");
                    sb.AppendLine("  https://ladowebservis.sk/Home/Produkty?q=zinobiotic");
                    sb.AppendLine();
                    sb.AppendLine(" Zobraziť všetky produkty: https://ladowebservis.sk/Home/Produkty");
                    sb.AppendLine();
                    // Registration invitation
                    sb.AppendLine("📝 ZAREGISTRUJTE SA A ZÍSKAJTE VÝHODY:");
                    sb.AppendLine();
                    sb.AppendLine("✓ Prístup k členskému zľavovému programu");
                    sb.AppendLine("✓ Rýchlejší nákup vďaka uloženým produktom");
                    sb.AppendLine("✓ Včasné informácie o novinkách a akciách");
                    sb.AppendLine("✓ Bonusové body za nákupy");
                    sb.AppendLine("✓ Bezplatná doprava nad 50€ v rámci SK");
                    sb.AppendLine("✓ Prioritná zákaznícka podpora");
                    sb.AppendLine();
                    sb.AppendLine("👉 Zaregistrovať sa: https://ladowebservis.sk/Home/Registracia");
                    sb.AppendLine();

                    // Additional benefits reminder
                    sb.AppendLine("💡 ČO VÁS EŠTE ČAKÁ PO REGISTRÁCII:");
                    sb.AppendLine();
                    sb.AppendLine("→ Osobný zoznam obľúbených produktov a ich zliav");
                    sb.AppendLine("→ História objednávok a sledovanie zásielok");
                    sb.AppendLine("→ Exkluzívny prémiový kód, e-maily s radami a tipmi");
                    sb.AppendLine("→ Možnosť hodnotenia produktov");
                    sb.AppendLine("→ 6 mesačná 10% zľava oproti klasickej objednávke");
                    sb.AppendLine();

                    // Cart reminder
                    sb.AppendLine("🛒 NEZABUDLI STE NIEČO V KOŠÍKU?");
                    sb.AppendLine();
                    sb.AppendLine("Ak ste si prezerali naše produkty a niečo zostalo vo Vašom košíku,");
                    sb.AppendLine("neváhajte dokončiť objednávku a využite svoj zľavový kód " + promoCode + "!");

                    sb.AppendLine();
                    sb.AppendLine("👉 Skontrolovať košík: https://ladowebservis.sk/Home/Kosik");
                    sb.AppendLine("👉 Stlačte Prejsť na platbu: https://buy.stripe.com/bJebJ1as6gng0SM8Sq4wM04?locale=sk&__embed_source=buy_btn_1SgujHHrPMzQ1ua8771vUUL4");
                    sb.AppendLine(); 

                    // How to use promo code
                    sb.AppendLine("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");
                    sb.AppendLine("AKO POUŽIŤ ZĽAVOVÝ KÓD na platobnej stránke Stripe a dokončiť objednávku:");
                    sb.AppendLine();
                    sb.AppendLine("1. Pridajte alebo si upravte produkty do vašej objednávky");
                    sb.AppendLine("2. Zadajte propagačný kód: " + promoCode);
                    sb.AppendLine("3. Kliknite na \"Použiť kupón\"");
                    sb.AppendLine("4. Zľava sa automaticky odpočíta");
                    sb.AppendLine("5. Vyplňte kontaktné údaje a spôsob platby");
                    sb.AppendLine("6. Dokončite objednávku na stránke a stlačte zaplatiť");
                    sb.AppendLine("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");
                    sb.AppendLine();

                    // Contact and support
                    sb.AppendLine("📞 MÁTE OTÁZKY?");
                    sb.AppendLine();
                    sb.AppendLine("Kontaktujte nás:");
                    sb.AppendLine("• Email: info@ladowebservis.sk");
                    sb.AppendLine("• Telefón: +421907151293 (iba SK)");
                    sb.AppendLine("• Web: https://ladowebservis.sk/Home/Kontakt");
                    sb.AppendLine();
                    sb.AppendLine("Ak chcete poradiť s výberom, odpíšte na tento e‑mail – radi pomôžeme.");
                    sb.AppendLine();
                    sb.AppendLine("S pozdravom,");
                    sb.AppendLine("Tím ladowebservis.sk");
                    sb.AppendLine();
                    sb.AppendLine("---");
                    sb.AppendLine("📧 SPRÁVA O EMAILOCH:");
                    sb.AppendLine("Ak si neželáte dostávať ďalšie ponuky a novinky, kliknite sem: " + GetUnsubscribeUrl(customerEmail));
                    sb.AppendLine();
                    sb.AppendLine("Stále budete dostávať informácie o svojich objednávkach.");

                    mail.Body = sb.ToString();

                    using (var client = new SmtpClient("email.active24.com"))
                    {
                        client.EnableSsl = true;
                        client.Port = 587;
                        client.UseDefaultCredentials = false;
                        client.Credentials = new NetworkCredential("info@ladowebservis.sk", "a98HdiBMYNRH");
                        client.Send(mail);
                    }
                }
            }
            catch
            {
                // ignore errors
            }
        }

        // Accepts optional attachment (HttpPostedFileBase) from MVC form file input
        public void OdoslanieEmailu(RegisterModel model, HttpPostedFileBase attachment = null)
        {
            // Block known spammer patterns (case-insensitive) - reject any containing 'loori'
            if (model != null)
            {
                var email = (model.Email ?? string.Empty).ToLowerInvariant();
                var name = (model.Name ?? string.Empty);
                
                // Check banned emails list
                if (BannedEmails.Any(b => email.Equals(b, StringComparison.OrdinalIgnoreCase)))
                {
                    return;
                }

                // Check banned fragments
                if (BannedEmailFragments.Any(b =>
                        (!string.IsNullOrEmpty(email) && email.IndexOf(b, StringComparison.OrdinalIgnoreCase) >= 0) ||
                        (!string.IsNullOrEmpty(name) && name.IndexOf(b, StringComparison.OrdinalIgnoreCase) >= 0)))
                {
                    return;
                }
            }

            using (var mail = new MailMessage())
            {
                mail.From = new MailAddress("info@ladowebservis.sk", "ladowebservis.sk");
                mail.Headers["X-Mailer"] = "ladowebservis.sk";
                mail.Subject = "Ďakujeme za Vašu registráciu.";
                mail.IsBodyHtml = false;
                mail.SubjectEncoding = Encoding.UTF8;
                mail.BodyEncoding = Encoding.UTF8;

                mail.Body = string.Format("\r\n Ďakujeme, že ste sa u nás zaregistrovali.Ako zaregistrovaný zákazník okrem iného získavate následovné výhody:" +
                    "\r\n Rýchlejší nákup vďaka vlastnému zoznamu obľúbených položiek." +
                    "\r\n Možnosť byť informovaný o novinkách a akciách." +
                    "\r\n Prístup do členskej sekcie a zľavového programu." + "\r\n\r\n" +
                    "\r\n Váš email: {0}" +
                    "\r\n Vaše meno: {1}" +
                    "\r\n Priezvisko: {2}," +
                    "\r\n Telefón: {3}" +
                    "\r\n Adresa: {4}" +
                    "\r\n Vaše mesto: {5}" +
                    "\r\n Potvrdenie emailu-(Captcha): {6}" +
                    "\r\n Vaše heslo: {7}" +
                    "\r\n Váš text:\r\n {8}" +
                    "\r\n\r\n Prajeme príjemný deň." +
                    "\r\n\r\n---\r\n📧 SPRÁVA O EMAILOCH:\r\nAk si neželáte dostávať ďalšie ponuky a novinky, kliknite sem: {9}\r\n\r\nStále budete dostávať informácie o svojich objednávkach." +
                    "\r\n\r\n S pozdravom ladowebservis.sk",
                    model.Email,
                    model.Name,
                    model.Priezvisko,
                    model.Phone,
                    model.Adresa,
                    model.City,
                    model.Captcha,
                    model.Password,
                    model.Text,
                    GetUnsubscribeUrl(model.Email));

                mail.To.Add(model.Email);
                mail.Bcc.Add("info@ladowebservis.sk");

                if (attachment != null && attachment.ContentLength > 0)
                {
                    var mailAttachment = new Attachment(attachment.InputStream, attachment.FileName, attachment.ContentType);
                    mail.Attachments.Add(mailAttachment);
                }

                using (var client = new SmtpClient("email.active24.com"))
                {
                    client.EnableSsl = true;
                    client.Port = 587;
                    client.UseDefaultCredentials = false;
                    client.Credentials = new NetworkCredential("info@ladowebservis.sk", "a98HdiBMYNRH");


                    client.Send(mail);
                }
            }

            // Extra: send a short promo / new products email after registration
            try
            {
                if (!string.IsNullOrWhiteSpace(model?.Email))
                {
                    SendNewProductsPromoEmail(model.Email, model.Name);
                }
            }
            catch
            {
                // ignore
            }
        }

        // Send a follow-up email containing product links to the specified recipient.
       
        public void SendProductsEmail(string customerEmail, string customerName = null, IEnumerable<string> cartProductIds = null)
        {
            if (string.IsNullOrWhiteSpace(customerEmail)) return;
            try
            {
                // validate email
                try { var _ = new MailAddress(customerEmail); } catch { return; }

                using (var mail = new MailMessage())
                {
                    mail.From = new MailAddress("info@ladowebservis.sk", "Ladowebservis");
                    mail.To.Add(customerEmail);
                    mail.Bcc.Add("info@ladowebservis.sk");
                    mail.Subject = "Odporúčané produkty od Ladowebservis";
                    mail.SubjectEncoding = Encoding.UTF8;
                    mail.IsBodyHtml = false; // send plain-text only

                    var nameSafe = string.IsNullOrWhiteSpace(customerName) ? "" : HttpUtility.HtmlEncode(customerName);

                    // Build plain-text body
                    var text = new StringBuilder();
                    text.AppendLine($"Dobrý deň {nameSafe},");
                    text.AppendLine();
                    text.AppendLine("Posielame výber odporúčaných produktov, ktoré by Vás mohli zaujímať:");
                    text.AppendLine();

                    try
                    {
                        var prodList = ProductCatalog.GetAll() ?? Enumerable.Empty<object>();

                        // If cartProductIds provided, list those first with more detail
                        if (cartProductIds != null && cartProductIds.Any())
                        {
                            text.AppendLine("Produkty, ktoré zostali vo Vašom košíku:");
                            foreach (var id in cartProductIds)
                            {
                                if (string.IsNullOrWhiteSpace(id)) continue;
                                dynamic found = null;
                                foreach (dynamic p in prodList)
                                {
                                    try {
                                        var pidTry = (p?.Id ?? string.Empty).ToString();
                                        if (pidTry.Equals(id, StringComparison.OrdinalIgnoreCase)) { found = p; break; }
                                    } catch { }
                                }
                                if (found != null)
                                {
                                    var pname = (found.Name ?? string.Empty).ToString();
                                    decimal pprice = 0m;
                                    try { pprice = Convert.ToDecimal(found.Price); } catch { decimal.TryParse((found.Price ?? "0").ToString(), out pprice); }
                                    string pdesc = string.Empty;
                                    try { pdesc = (found.Description ?? found.Text ?? found.Info ?? found.ShortDescription ?? string.Empty).ToString(); } catch { pdesc = string.Empty; }
                                    var productUrl = UrlForProduct((found.Id ?? string.Empty).ToString());

                                    text.AppendLine($"- {pname} — €{pprice:0.00}");
                                    if (!string.IsNullOrWhiteSpace(pdesc))
                                    {
                                        var shortDesc = pdesc.Length > 300 ? pdesc.Substring(0, 300) + "..." : pdesc;
                                        text.AppendLine("  Popis: " + shortDesc);
                                    }
                                    text.AppendLine("  Stránka produktu: " + productUrl);
                                    text.AppendLine();
                                }
                                else
                                {
                                    // fallback: include id and link
                                    text.AppendLine($"- Produkt ID: {id} (zobraziť: {UrlForProduct(id)})");
                                    text.AppendLine();
                                }
                            }

                            text.AppendLine();
                            text.AppendLine("Nižšie sú ďalšie odporúčené produkty:");
                            text.AppendLine();
                        }

                        // General product list (brief)
                        foreach (dynamic p in prodList)
                        {
                            if (p == null) continue;
                            var pid = (p.Id ?? string.Empty).ToString();
                            var pname = (p.Name ?? string.Empty).ToString();
                            decimal pprice = 0m;
                            try { pprice = Convert.ToDecimal(p.Price); } catch { decimal.TryParse((p.Price ?? "0").ToString(), out pprice); }
                            var link = UrlForProduct(pid);
                            text.AppendLine($"- {pname} — €{pprice:0.00} — {link}");
                        }
                    }
                    catch
                    {
                        text.AppendLine("Zobraziť naše produkty: https://ladowebservis.sk/Home/Produkty");
                    }

                    text.AppendLine();
                    text.AppendLine("Ak chcete, môžeme Vám produkty zaslať neskôr znova. Stačí odpovedať na tento e‑mail.");
                    text.AppendLine();
                    text.AppendLine("S pozdravom,\nTím Ladowebservis");
                    text.AppendLine();
                    text.AppendLine("---");
                    text.AppendLine("📧 SPRÁVA O EMAILOCH:");
                    text.AppendLine("Ak si neželáte dostávať ďalšie ponuky a novinky, kliknite sem: " + GetUnsubscribeUrl(customerEmail));
                    text.AppendLine();
                    text.AppendLine("Stále budete dostávať informácie o svojich objednávkach.");

                    mail.Body = text.ToString();
                    mail.BodyEncoding = Encoding.UTF8;

                    // do not add HTML alternate view; send plain text only

                    using (var client = new SmtpClient("email.active24.com"))
                    {
                        client.EnableSsl = true;
                        client.Port = 587;
                        client.UseDefaultCredentials = false;
                        client.Credentials = new NetworkCredential("info@ladowebservis.sk", "a98HdiBMYNRH");
                        client.Send(mail);
                    }
                }
            }
            catch
            {
                // ignore send errors
            }
        }

        // Send a short promo email with new/featured products and promo code.
        // Used as a follow-up after registration confirmation.
        private void SendNewProductsPromoEmail(string customerEmail, string customerName = null)
        {
            if (string.IsNullOrWhiteSpace(customerEmail)) return;

            try
            {
                try { var _ = new MailAddress(customerEmail); } catch { return; }

                var nameSafe = string.IsNullOrWhiteSpace(customerName) ? "" : HttpUtility.HtmlEncode(customerName).Trim();
                var promoCode = "REGZAK26";

                // Use Produkty page with query as a simple way to highlight modern products (e.g., balance)
                var productsUrl = "https://ladowebservis.sk/Home/Produkty";
                var balzmUrl = "https://ladowebservis.sk/Home/Produkty?q=" + HttpUtility.UrlEncode("balzam");
                var omegaUrl = "https://ladowebservis.sk/Home/Produkty?q=" + HttpUtility.UrlEncode("balance");
                var probioticUrl = "https://ladowebservis.sk/Home/Produkty?q=" + HttpUtility.UrlEncode("zinobiotic");

                using (var mail = new MailMessage())
                {
                    mail.From = new MailAddress("info@ladowebservis.sk", "ladowebservis.sk");
                    mail.To.Add(customerEmail);
                    mail.Bcc.Add("info@ladowebservis.sk");
                    mail.Subject = "Novinky a špeciálna zľava 10% – použite nový kód " + promoCode;
                    mail.SubjectEncoding = Encoding.UTF8;
                    mail.BodyEncoding = Encoding.UTF8;
                    mail.IsBodyHtml = false;

                    var sb = new StringBuilder();
                    if (!string.IsNullOrWhiteSpace(nameSafe))
                    {
                        sb.AppendLine("Dobrý deň " + nameSafe + ",");
                    }
                    else
                    {
                        sb.AppendLine("Dobrý deň,");
                    }

                    sb.AppendLine();
                    sb.AppendLine("Ďakujeme, že ste s nami. Máme pre Vás niečo extra – nové moderné produkty pre Vaše zdravie a špeciálny bonus do košíka.");
                    sb.AppendLine("Tento špeciálny bonus platí len pre zaregistrovaných zákazníkov na produkty už od 50€ po dobu 6 mesiacov!");
                    sb.AppendLine();
                    sb.AppendLine("PROMO KÓD: " + promoCode);
                    sb.AppendLine("Zadajte ho v košíku a získate 10% zľavu");
                    sb.AppendLine();
                    sb.AppendLine("Tipy na novinky / obľúbené produkty:");
                    sb.AppendLine("• Balzamy: " + balzmUrl);
                    sb.AppendLine("• Omega 3 a zdravie: " + omegaUrl);
                    sb.AppendLine("• Probiotiká (Zinobiotic): " + probioticUrl);
                    sb.AppendLine();
                    sb.AppendLine("Pozrieť všetky produkty:");
                    sb.AppendLine(productsUrl);
                    sb.AppendLine();
                    sb.AppendLine("Ak chcete poradiť s výberom, odpíšte na tento e‑mail – radi pomôžeme.");
                    sb.AppendLine();
                    sb.AppendLine("S pozdravom,");
                    sb.AppendLine("Tím ladowebservis.sk");
                    sb.AppendLine();
                    sb.AppendLine("---");
                    sb.AppendLine("📧 SPRÁVA O EMAILOCH:");
                    sb.AppendLine("Ak si neželáte dostávať ďalšie ponuky a novinky, kliknite sem: " + GetUnsubscribeUrl(customerEmail));
                    sb.AppendLine();
                    sb.AppendLine("Stále budete dostávať informácie o svojich objednávkach.");

                    mail.Body = sb.ToString();

                    using (var client = new SmtpClient("email.active24.com"))
                    {
                        client.EnableSsl = true;
                        client.Port = 587;
                        client.UseDefaultCredentials = false;
                        client.Credentials = new NetworkCredential("info@ladowebservis.sk", "a98HdiBMYNRH");
                        client.Send(mail);
                    }
                }
            }
            catch
            {
                // ignore send errors
            }
        }

        // helper to build product URL (simple fallback)
        private static string UrlForProduct(String productId)
        {
            if (String.IsNullOrWhiteSpace(productId)) return "https://ladowebservis.sk/Home/Produkty";
            // attempt to link to a product details route
            return "https://ladowebservis.sk/Home/Produkt?id=" + HttpUtility.UrlEncode(productId);
        }
    }
}


































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































