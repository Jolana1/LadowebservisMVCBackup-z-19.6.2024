using LadowebservisMVC.Controllers.Models;
using LadowebservisMVC.Models;
using LadowebservisMVC.Util;
using System;
using System.Net.Mail;
using System.Web.Mvc;
using System.Net;
using System.IO;
using System.Web.Script.Serialization;
using System.Linq;
using System.Collections.Generic;

namespace LadowebservisMVC.Controllers
{
    [HandleError]
    public class HomeController : Controller
    {
        // GET: Home
        public ActionResult Zdravie()
        {
            ViewBag.PageTitle = "zdravie";
            return View();
        }

        public ActionResult ITservis()
        {
            ViewBag.PageTitle = "itservis";
            return View();
        }

        public ActionResult Login(LoginModel model)
        {
            // Only attempt login when model is valid
            if (ModelState.IsValid && model != null)
            {
                if (model.Email == "Name" && model.Password == "Password")
                {
                    // create MemberInfoModel from LoginModel values (map by property name) and save to session
                    try
                    {
                        var memberInfo = new MemberInfoModel();
                        var fromType = model.GetType();
                        var toType = memberInfo.GetType();
                        foreach (var p in fromType.GetProperties(System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.Instance))
                        {
                            try
                            {
                                var dest = toType.GetProperty(p.Name, System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.Instance);
                                if (dest != null && dest.CanWrite)
                                {
                                    dest.SetValue(memberInfo, p.GetValue(model, null));
                                }
                            }
                            catch { }
                        }
                        Session["MemberInfo"] = memberInfo;
                    }
                    catch { }

                    // redirect to member information page on successful login
                    return RedirectToAction("MemberInfo", "Home");
                }
                else
                {
                    ModelState.AddModelError("", "Neplatné prihlasovacie údaje.");
                }
            }
            return View(model);
        }

        // GET: Member (show member form)
        public ActionResult Member()
        {
            ViewBag.PageTitle = "Member";
            return View(new MemberModel());
        }

        [HttpPost]
        public ActionResult Member(MemberModel model)
        {
            ViewBag.PageTitle = "Member";
            if (ModelState.IsValid && model != null)
            {
                if (model.Meno == "Name" && model.Heslo == "Heslo")
                {
                    // redirect to member info on success
                    return RedirectToAction("MemberInfo", "Home");
                }
                else
                {
                    ModelState.AddModelError("", "Neplatné údaje člena.");
                }
            }
            return View(model);
        }

        public ActionResult MemberInfo()
        {
            ViewBag.PageTitle = "Member";
            // Read MemberInfoModel from session if available
            var mi = Session["MemberInfo"] as MemberInfoModel;
            if (mi == null) mi = new MemberInfoModel();
            return View(mi);
        }

        public ActionResult Kontakt()
        {
            ViewBag.PageTitle = "Kontakt";
            ContactModel_Sk model = new ContactModel_Sk();
            return View(model);
        }

        [HttpPost]
        public ActionResult OdoslanieSpravy(ContactModel_Sk model)
        {
            ViewBag.PageTitle = "OdoslanieSpravy";
            if (ModelState.IsValid)
            {
                try
                {
                    Mailer mailer = new Mailer();
                    mailer.OdoslanieSpravy(model);
                    return View();
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Trace.TraceError($"Email send failed: {ex.Message}");
                    ModelState.AddModelError("", "Odoslanie správy sa nepodarilo. Skúste to prosím znova.");
                    return View("Kontakt", model);
                }
            }
            return View("Kontakt", model);
        }

        public ActionResult Registracia()
        {
            ViewBag.PageTitle = "Registracia";
            RegisterModel model = new RegisterModel();
            return View(model);
        }

        // Show registration confirmation page
        [HttpGet]
        public ActionResult OdoslanieReg()
        {
            ViewBag.PageTitle = "OdoslanieReg";
            return View();
        }

        [HttpPost]
        public ActionResult OdoslanieReg(RegisterModel model)
        {
            ViewBag.PageTitle = "OdoslanieReg";
            if (ModelState.IsValid)
            {
                try
                {
                    var mailer = new Mailer();
                    mailer.OdoslanieEmailu(model);

                    // allow access to ordering after successful registration
                    TempData["CanOrder"] = true;

                    // Redirect to the registration confirmation page
                    return RedirectToAction("OdoslanieReg", "Home");
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Trace.TraceError($"Registration email failed: {ex.Message}");
                    ModelState.AddModelError("", "Registrácia sa nepodarila. Skúste to prosím znova.");
                    return View("Registracia", model);
                }
            }

            // On validation errors, re-render registration with validation messages
            return View("Registracia", model);
        }

        public ActionResult Hudba()
        {
            ViewBag.PageTitle = "Hudba";
            return View();
        }

        public ActionResult Objednavky()
        {
            ViewBag.PageTitle = "Objednavky";
            return View();
        }

        public ActionResult Produkty()
        {
            ViewBag.PageTitle = "Produkty";
            OrderModel model = new OrderModel();

            // Simple search by name or id via query string
            try
            {
                var q = (Request?["q"] ?? string.Empty).Trim();
                var id = (Request?["id"] ?? string.Empty).Trim();
                var all = ProductCatalog.GetAll() ?? new List<ProductInfo>();

                IEnumerable<ProductInfo> results = all;
                if (!string.IsNullOrEmpty(id))
                {
                    results = results.Where(p => p != null && string.Equals(p.Id, id, StringComparison.OrdinalIgnoreCase));
                }
                if (!string.IsNullOrEmpty(q))
                {
                    results = results.Where(p => p != null && (p.Name ?? string.Empty).IndexOf(q, StringComparison.OrdinalIgnoreCase) >= 0);
                }

                ViewBag.Products = results.ToList();
            }
            catch { ViewBag.Products = new List<ProductInfo>(); }

            return View(model);
        }

        public ActionResult Kosik()
        {
            ViewBag.PageTitle = "Kosik";
            return View();
        }

        public ActionResult Favorites()
        {
            ViewBag.PageTitle = "Obľúbené produkty";
            return View();
        }

        // Unsubscribe from marketing emails
        [HttpGet]
        public ActionResult Unsubscribe(string email, string token)
        {
            ViewBag.PageTitle = "Odhlásenie z odberu";
            
            // Validate email and token
            if (string.IsNullOrWhiteSpace(email))
            {
                ViewBag.Error = "Neplatný email.";
                return View();
            }

            // TODO: Implement actual unsubscribe logic here
            // For now, just pass the email to the view
            ViewBag.Email = email;
            ViewBag.UnsubscribeSuccess = true;

            try
            {
                // Log unsubscribe request
                System.Diagnostics.Trace.TraceInformation($"Unsubscribe request: {email}");
                
                // TODO: Add email to unsubscribe list in database or file
                // Example: UnsubscribeService.Add(email);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Trace.TraceError($"Unsubscribe error: {ex.Message}");
                ViewBag.Error = "Vyskytla sa chyba pri odhlasovaní.";
                ViewBag.UnsubscribeSuccess = false;
            }

            return View();
        }

        // About page
        public ActionResult About()
        {
            ViewBag.PageTitle = "O nás";
            return View();
        }

        // Place order (bank transfer)
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult PlaceOrder(PlaceOrderModel model)
        {
            try
            {
                if (model == null)
                {
                    return RedirectToAction("Produkty");
                }

                // parse cart JSON into Items
                if (string.IsNullOrWhiteSpace(model.CartJson))
                {
                    ModelState.AddModelError("CartJson", "Nákupný košík je prázdny.");
                }
                else
                {
                    try
                    {
                        var js = new JavaScriptSerializer();
                        model.Items = js.Deserialize<List<OrderItem>>(model.CartJson) ?? new List<OrderItem>();
                    }
                    catch
                    {
                        model.Items = new List<OrderItem>();
                        ModelState.AddModelError("CartJson", "Chyba pri spracovaní košíka.");
                    }
                }

                // Server-side validation: compare prices and stock with ProductCatalog
                var catalogErrors = new List<string>();
                foreach (var item in model.Items)
                {
                    if (ProductCatalog.TryGetById(item.Id, out var info))
                    {
                        // check stock
                        if (item.Quantity <= 0 || item.Quantity > info.Stock)
                        {
                            catalogErrors.Add($"Nesprávne množstvo pre produkt {info.Name}.");
                        }

                        // check price
                        if (item.UnitPrice != info.Price)
                        {
                            item.UnitPrice = info.Price;
                            catalogErrors.Add($"Cena produktu {info.Name} bola upravená podľa katalógu.");
                        }
                    }
                    else
                    {
                        catalogErrors.Add($"Produkt s ID '{item.Id}' neexistuje.");
                    }
                }

                if (catalogErrors.Any())
                {
                    foreach (var e in catalogErrors) ModelState.AddModelError("CartJson", e);
                }

                var total = model.Items?.Sum(i => i.LineTotal) ?? 0m;

                if (!ModelState.IsValid)
                {
                    return RedirectToAction("Kosik");
                }

                ViewBag.Items = model.Items;
                ViewBag.Total = total;
                ViewBag.PaymentMethod = "bank";

                return View("OrderPlaced");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Trace.TraceError($"Order placement error: {ex.Message}");
                TempData["ErrorMessage"] = "Objednávka sa nepodarila. Skúste to prosím znova.";
                return RedirectToAction("Error");
            }
        }

        // Start Stripe checkout
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult StartStripeCheckout(PlaceOrderModel model)
        {
            try
            {
                if (model == null)
                {
                    return RedirectToAction("Produkty");
                }

                var js = new JavaScriptSerializer();
                model.Items = js.Deserialize<List<OrderItem>>(model.CartJson) ?? new List<OrderItem>();

                var total = model.Items?.Sum(i => i.LineTotal) ?? 0m;

                if (model.Items == null || model.Items.Count == 0)
                {
                    return RedirectToAction("Kosik");
                }

                ViewBag.Items = model.Items;
                ViewBag.Total = total;
                ViewBag.PaymentMethod = "stripe";

                return View("OrderPlaced");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Trace.TraceError($"Stripe checkout error: {ex.Message}");
                TempData["ErrorMessage"] = "Platba sa nepodarila. Skúste to prosím znova.";
                return RedirectToAction("Error");
            }
        }

        // Start PayPal checkout
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult StartPayPalCheckout(PlaceOrderModel model)
        {
            try
            {
                if (model == null)
                {
                    return RedirectToAction("Produkty");
                }

                var js = new JavaScriptSerializer();
                model.Items = js.Deserialize<List<OrderItem>>(model.CartJson) ?? new List<OrderItem>();

                var total = model.Items?.Sum(i => i.LineTotal) ?? 0m;

                if (model.Items == null || model.Items.Count == 0)
                {
                    return RedirectToAction("Kosik");
                }

                ViewBag.Items = model.Items;
                ViewBag.Total = total;
                ViewBag.PaymentMethod = "paypal";

                return View("OrderPlaced");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Trace.TraceError($"PayPal checkout error: {ex.Message}");
                TempData["ErrorMessage"] = "Platba sa nepodarila. Skúste to prosím znova.";
                return RedirectToAction("Error");
            }
        }

        public ActionResult ReturnPolicy()
        {
            ViewBag.PageTitle = "ReturnPolicy";
            return View();
        }

        public ActionResult Gdpr()
        {
            ViewBag.PageTitle = "GDPR";
            return View();
        }

        public ActionResult ObchodnePodmienky()
        {
            ViewBag.PageTitle = "Obchodné Podmienky";
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult DownloadEbook(DownloadEbookModel model)
        {
            ViewBag.PageTitle = "DownloadEbook";

            if (!ModelState.IsValid)
            {
                return View(model);
            }

            try
            {
                var contact = new ContactModel_Sk
                {
                    Name = model.Name,
                    Email = model.Email,
                    Text = model.Sprava ?? string.Empty,
                    Password = model.Captcha,
                    File = model.File
                };

                var mailer = new Mailer();
                mailer.OdoslanieSpravy(contact, model.File);

                TempData["EbookSuccess"] = true;
                return RedirectToAction("DownloadEbook", new { success = 1 });
            }
            catch (Exception ex)
            {
                System.Diagnostics.Trace.TraceError($"E-book email send failed: {ex}");
                ModelState.AddModelError(string.Empty, "Odoslanie e‑mailu sa nepodarilo. Skúste to prosím znova o chvíľu.");
                return View(model);
            }
        }

        public ActionResult DownloadEbook()
        {
            ViewBag.PageTitle = "DownloadEbook";
            var model = new DownloadEbookModel();
            if (TempData["EbookSuccess"] != null && (bool)TempData["EbookSuccess"] == true)
            {
                ViewBag.EbookSuccess = true;
            }
            return View(model);
        }

        // Error page with proper error handling
        public ActionResult Error()
        {
            ViewBag.PageTitle = "Chyba";
            
            // Get error message from TempData if available
            if (TempData["ErrorMessage"] != null)
            {
                ViewBag.ErrorMessage = TempData["ErrorMessage"];
            }

            // Get exception from Server if available
            var exception = Server.GetLastError();
            if (exception != null)
            {
                ViewBag.ErrorDetails = exception.Message;
                System.Diagnostics.Trace.TraceError($"Application error: {exception}");
            }

            // Check for HTTP status code
            var httpContext = System.Web.HttpContext.Current;
            if (httpContext != null && httpContext.Response != null)
            {
                var statusCode = httpContext.Response.StatusCode;
                ViewBag.StatusCode = statusCode;

                if (statusCode == 404)
                {
                    ViewBag.ErrorTitle = "Stránka nenájdená";
                    ViewBag.ErrorMessage = "Požadovaná stránka neexistuje alebo bola presunutá.";
                }
                else if (statusCode == 500)
                {
                    ViewBag.ErrorTitle = "Chyba servera";
                    ViewBag.ErrorMessage = "Vyskytla sa chyba na serveri. Prosím skúste to znova.";
                }
                else if (statusCode == 403)
                {
                    ViewBag.ErrorTitle = "Prístup zamietnutý";
                    ViewBag.ErrorMessage = "Nemáte oprávnenie na prístup k tejto stránke.";
                }
                else
                {
                    ViewBag.ErrorTitle = "Vyskytla sa chyba";
                    if (ViewBag.ErrorMessage == null)
                    {
                        ViewBag.ErrorMessage = "Niečo sa pokazilo. Prosím skúste to znova.";
                    }
                }
            }
            else
            {
                ViewBag.ErrorTitle = "Vyskytla sa chyba";
                if (ViewBag.ErrorMessage == null)
                {
                    ViewBag.ErrorMessage = "Niečo sa pokazilo. Prosím skúste to znova.";
                }
            }

            // Clear error to prevent infinite loop
            Server.ClearError();

            return View();
        }

        // Custom 404 Not Found handler
        public ActionResult NotFound()
        {
            ViewBag.PageTitle = "404 - Stránka nenájdená";
            ViewBag.ErrorTitle = "Stránka nenájdená";
            ViewBag.ErrorMessage = "Požadovaná stránka neexistuje alebo bola presunutá.";
            ViewBag.StatusCode = 404;
            
            Response.StatusCode = 404;
            Response.TrySkipIisCustomErrors = true;
            
            return View("Error");
        }

        // Override OnException for additional error handling
        protected override void OnException(ExceptionContext filterContext)
        {
            if (filterContext.ExceptionHandled)
                return;

            // Log the error
            var exception = filterContext.Exception;
            System.Diagnostics.Trace.TraceError($"Unhandled exception: {exception}");

            // Set error details in TempData
            TempData["ErrorMessage"] = "Vyskytla sa neočakávaná chyba. Prosím skúste to znova.";

            // Mark as handled
            filterContext.ExceptionHandled = true;

            // Redirect to error page
            filterContext.Result = RedirectToAction("Error");
        }
    }
}
















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































